#################### ğŸ”§ Build Stage ####################
FROM gradle:jdk17 AS builder
WORKDIR /app

# â”€â”€ Gradle ì„¤ì • ë³µì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY build.gradle settings.gradle ./
COPY gradle ./gradle
COPY gradlew* ./
# â”€â”€ ì†ŒìŠ¤ ë³µì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY src ./src

# â”€â”€ CRLF ì œê±° & ë¹Œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RUN chmod +x ./gradlew && \
    apt-get update && apt-get install -y dos2unix && \
    dos2unix ./gradlew || sed -i 's/\r$//' ./gradlew && \
    ./gradlew clean war --no-daemon -x test

#################### ğŸš€ Run Stage ####################
FROM tomcat:9.0.53-jdk17-openjdk
ENV TZ=Asia/Seoul

# 1ï¸âƒ£ ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y curl wget netcat python3 bash && \
    rm -rf /var/lib/apt/lists/*   # ì´ë¯¸ì§€ ê²½ëŸ‰í™”

# 2ï¸âƒ£ WAR ë°°í¬
RUN rm -rf $CATALINA_HOME/webapps/*
COPY --from=builder /app/build/libs/*.war $CATALINA_HOME/webapps/ROOT.war

# 3ï¸âƒ£ í”Œë˜ê·¸ íŒŒì¼
COPY flag.txt /flag.txt

EXPOSE 8080
CMD ["catalina.sh", "run"]
