#################### ğŸ”§ Build Stage ####################
FROM gradle:jdk17 AS builder
WORKDIR /app

# â”€â”€ Gradle ì„¤ì • ë³µì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY build.gradle settings.gradle ./
COPY gradle ./gradle
COPY gradlew* ./
# â”€â”€ ì†ŒìŠ¤ ë³µì‚¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COPY src ./src
COPY src/main/webapp ./src/main/webapp

# â”€â”€ CRLF ì œê±° & ë¹Œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RUN chmod +x ./gradlew && \
    apt-get update && apt-get install -y dos2unix && \
    dos2unix ./gradlew || sed -i 's/\r$//' ./gradlew && \
    ./gradlew clean war --no-daemon -x test

#################### ğŸš€ Run Stage (cron í¬í•¨) #########
FROM tomcat:9.0.53-jdk17-openjdk
ENV TZ=Asia/Seoul

# 1ï¸âƒ£ ìœ í‹¸ë¦¬í‹° + cron ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y curl wget netcat python3 bash cron && \
    rm -rf /var/lib/apt/lists/*   # ì´ë¯¸ì§€ ê²½ëŸ‰í™”

# 2ï¸âƒ£ 30ë¶„ë§ˆë‹¤ webapps/ROOT/* ì‚­ì œí•˜ëŠ” cron ë“±ë¡
RUN echo '*/30 * * * * root rm -rf /usr/local/tomcat/webapps/ROOT/*' \
      > /etc/cron.d/cleanup && \
    chmod 0644 /etc/cron.d/cleanup && \
    crontab /etc/cron.d/cleanup          # root í¬ë¡ ì— ë“±ë¡

# 3ï¸âƒ£ WAR ë°°í¬
RUN rm -rf $CATALINA_HOME/webapps/*
COPY --from=builder /app/build/libs/*.war $CATALINA_HOME/webapps/ROOT.war

# 4ï¸âƒ£ (ì„ íƒ) í”Œë˜ê·¸ íŒŒì¼
COPY flag.txt /flag.txt

EXPOSE 8080
# 5ï¸âƒ£ cron + Tomcat ë™ì‹œ ì‹¤í–‰
CMD ["sh", "-c", "cron && catalina.sh run"]

